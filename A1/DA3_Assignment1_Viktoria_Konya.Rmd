---
header-includes: |
  \usepackage{titling}
  \setlength{\droptitle}{-6em} 
title: "DA3 - Assignment 1"
author:  "Viktória Kónya"
date: "`r format(Sys.time(), '%d %B %Y')`"
geometry: margin=1.8cm
fontsize: 9pt
output: 
  pdf_document:
    extra_dependencies: ["flafter"]
---

```{r setup, include=FALSE}

# Chunk setup
knitr::opts_chunk$set(warning = FALSE, message = FALSE)

```

```{r import_libraries, echo = F, include = F}

# Clear environment
rm(list=ls())

# Import libraries
library(tidyverse)
library(modelsummary)
library(kableExtra)
library(gridExtra) # multiple-plots
library(grid)
# library(estimatr)
library(fixest)
library(caret) 
library(GGally) # pairwise 

```

```{r import_dataset, echo = F, include = F}

# Import dataset
df_orig <- read_csv("https://osf.io/4ay9x/download") 

```


```{r custom_function, echo = F, include = F}

# Create custom functions for visualization

# A. Histograms
histograms <- function( x_var , x_lab, bin ){
  n = nrow(df)
  
  ggplot( df , aes(x = x_var)) +
    geom_histogram( binwidth = bin, fill="#238b45", color = 'gray50', na.rm = T) +
    stat_function(fun = function(x) dnorm(x, mean = mean(x_var, na.rm = T), sd = sd(x_var, na.rm = T)) * n * bin, color = "darkred", size = 1, na.rm = T) +
    labs(y = 'Count',x = x_lab ) +
    theme_bw() +
      theme(
        plot.title = element_text(size = 12L,
        face = "bold", hjust = 0.5),
        axis.title.y = element_text(face = "bold"),
        axis.title.x = element_text(face = "bold"),
        legend.position = "none"
     )
}

# B. Scatterplot
scatter <- function( data, x_var , y_var, x_lab, y_lab, chart_title){
  
  ggplot( data , aes(x = {{ x_var }}, y = {{ y_var }})) +
    geom_point(color="#2ca25f",size=0.5,alpha=0.6, na.rm = T) +
    geom_smooth(method="loess" , formula = y ~ x , na.rm = T)+
    labs(x = x_lab, y = y_lab) +
    #ggtitle(chart_title) +
    theme_bw() +
    theme(
    plot.title = element_text(size = 12L,
    face = "bold", hjust = 0.5),
    axis.title.y = element_text(face = "bold"),
    axis.title.x = element_text(face = "bold"),
    legend.position = "none"
    )
}

# C. Bin scatters
bin_scatters_multi <- function( data,  x_var , y_var, x_lab, y_lab){

  data %>%   
  ggplot() +
  geom_jitter(aes(x = as.factor({{ x_var }}), y = {{ y_var }}), width = 0.25, color = "#2ca25f", alpha = 0.6, size = 0.5) +
  geom_crossbar(data = df %>% group_by({{ x_var }}) %>% dplyr::summarize( avg = mean({{ y_var }}, na.rm = T)), aes(x = as.factor({{ x_var }}), y = avg, ymin = avg, ymax = avg), size=0.5,col="black", width = 0.4) +
  #scale_x_discrete(labels = c(lab_x1, lab_x2, lab_x3, lab_x4, lab_x5, "NA")) +
  labs(x = x_lab, y = y_lab) +
  theme_bw() +
  theme(
    plot.title = element_text(size = 12L,
    face = "bold", hjust = 0.5),
    axis.title.y = element_text(face = "bold"),
    axis.title.x = element_text(face = "bold"),
    legend.position = "none"
 )
}


# D. Interactions
interactions <- function(df, outcome_var, factor_var, dummy_var, outcome_lab, factor_lab, dummy_lab){

  # Process your data frame and make a new dataframe which contains the stats
  outcome_var <- as.name(outcome_var)
  factor_var <- as.name(factor_var)
  dummy_var <- as.name(dummy_var)
  
  stats <- df %>%
    group_by(!!factor_var, !!dummy_var) %>%
    dplyr::summarize(Mean = mean(!!outcome_var, na.rm=TRUE),
                     se = sd(!!outcome_var)/sqrt(n()))
  
  stats[,2] <- lapply(stats[,2], factor)
  
  ggplot(stats, aes_string(colnames(stats)[1], colnames(stats)[3], fill = colnames(stats)[2]))+
    geom_bar(stat='identity', position = position_dodge(width=0.9), alpha=0.8)+
    geom_errorbar(aes(ymin=Mean-(1.96*se),ymax=Mean+(1.96*se)),
                  position=position_dodge(width = 0.9), width = 0.25)+
    scale_color_manual(name=dummy_lab, values=c("#2ca25f","#3182bd")) +
    scale_fill_manual(name=dummy_lab, values=c("#2ca25f","#3182bd"), labels=c("Male", "Female")) +
    labs(x= factor_lab, y = outcome_lab, fill = dummy_lab)+
    theme_bw()+
    theme(
        legend.position = "bottom",
        axis.title.y = element_text(face = "bold"),
        axis.title.x = element_text(face = "bold"),
        legend.title = element_blank())
    
}

# E. Blank cell
blank <- grid.rect(gp=gpar(col="white"))


```


\vspace{-10mm}
### Introduction
\vspace{-3mm}

The goal of this report is to predict the hourly wages of Financial managers focusing on professionals with undergraduate or graduate degrees (BA or higher).


### Sample selection
\vspace{-3mm}

The source of my analysis is the CPS dataset that I filtered based on occupation code and the education level. Managers between the age of 21 and 64 and with the minimum of 20 working hours per week were considered only in order to focus on the active labor force with a degree. Observations with earnings below one dollar per hour were excluded as such low wage is unlikely among Financial managers. The sample consists of 881 observations with 416 women and 446 men.


```{r data_cleaning_sample, echo = F, include = F}

# Data cleaning & sample selection 
# Business question: predict hourly wages among Financial managers with university degree ( -> same sample as in DA2 Assignment 1)

# Filter for occupation - 1020: Financial managers - 1401 obs.
df <- df_orig %>% filter( occ2012 %in% c(0120) )

# Data preparation
df <- df %>% 
  
  # Filter : has hourly earning larger than one dollar, min. BA degree, active age
  filter( uhours>=20 & earnwke>uhours & grade92>=43 & age>=21 & age<=64)  %>%
  
  # Create gender dummy and character version for summary table
  mutate( female = as.numeric( sex==2 ) ) %>% 
  mutate( female_char = case_when(
            female == 1 ~ "Female",
            female == 0 ~ "Male" )) %>%
  
  # Create hourly wage
  mutate( w = earnwke/uhours ) %>%
    
  # Create log hourly wage
  mutate( lnw = log( w ) ) %>%
    
  # Create age polinomials
  mutate(agesq=age^2,
         agecu=age^3,
         agequ = age^4) %>%
    
  # Create education groups for summary table
  mutate(educ = factor(case_when(
          grade92 == 43 ~ "BA Degree",
          grade92 == 44 ~ "MA Degree", 
          grade92 == 45 ~ "Professional",
          grade92 == 46 ~ "PhD"),
          levels = c("BA Degree", 
                     "MA Degree", 
                     "Professional",
                     "PhD"))) %>% 
    
  # Create education dummies
  mutate(
          educ_BA = ifelse(educ == "BA Degree", 1, 0),
          educ_MA = ifelse(educ == "MA Degree", 1, 0),  
          educ_Profess = ifelse(educ == "Professional", 1, 0),  
          educ_PhD = ifelse(educ == "PhD", 1, 0))  %>%

  # Create class flag
  mutate(class_cat = case_when(
            class %in% c('Government - Federal' , 'Government - State', 'Government - Local') ~ 0,
            class %in% c('Private, For Profit' , 'Private, Nonprofit') ~ 1)) %>%
         
  # Union membership
  mutate(union_membership = case_when(
            unionmme %in% c('Yes') ~ 1,
            unionmme %in% c('No') ~ 0))  %>%

  # Own child
  mutate(has_child = case_when(
            ownchild == 0 ~ 0,
            ownchild > 0 ~ 1))  %>%
  
  # Keep only the useful fields
  select(hhid, earnwke, uhours, w, lnw, age, agesq, agecu, agequ, female, class_cat, educ, educ_BA, educ_MA, educ_Profess, educ_PhD, union_membership, has_child, state, race, marital, ethnic)

  
# Check other variables 
unique(df$state)
unique(df$marital)
unique(df$race)
unique(df$ethnic)

# Summary
summary(df)

```


```{r eda_summary_table, echo = F, include = F}

# EDA

# A. Summary statistics
# Note: Moved to Appendix A1

P95 <- function(x){quantile(x,0.95,na.rm=T)}
P05 <- function(x){quantile(x,0.05,na.rm=T)}
Range <- function(x){max(x, na.rm = TRUE) - min(x, na.rm = TRUE)}
Missing <- function(x){sum(is.na(x))}

eda_summary_table <- datasummary(  
              ( `Earnings` = earnwke ) +
              ( `Hours worked` = uhours ) +
              ( `Hourly wage` = w ) +
              ( `Log of Hourly wage` = lnw ) + 
              ( `Age` = age ) +  
              ( `Female` = female ) +
              ( `Job type` = class_cat ) +
              ( `BA Degree` = educ_BA ) + 
              ( `MA Degree` = educ_MA ) +                 
              ( `Professional` = educ_Profess ) +                 
              ( `PhD` = educ_PhD ) +
              ( `Union member` = union_membership ) +
              ( `Child`= has_child ) ~
    (N + Missing + Mean + SD + Min + Max + Range + P05 + Median  + P95),
    data = df,
    title = 'Descriptive statistics' ) %>% 
    kableExtra::kable_styling(latex_options = "hold_position", font_size = 9)

# Summary
summary(df)


```



```{r eda_1_var_analysis, echo = F, include = F}

# EDA 

# B. Distributions
# Moved to Appendix A2

# Earnings
hist_earnings <- histograms(df$earnwke, 'Earings', bin = 100 ) 

# Hours worked
hist_hours_worked <- histograms(df$uhours, 'Hours worked', bin = 1)

# Hourly wage
hist_hourly_wage <- histograms(df$w, 'Hourly wage', bin = 3)

# Ln hourly wage
hist_log_hourly_wage <- histograms(df$lnw, 'Log of Hourly wage', bin = 0.1)

# Age
hist_age <- histograms(df$age, 'Age', bin = 3)

```


```{r eda_pairwise_analysis, echo = F, include = F}

# EDA

# C. Scatter plots
# Moved to Appendix A3

# Age
scatter_w_age <- scatter(data = df, x_var = age, y_var = w, x_lab = "Age", y_lab = "Hourly wages") 
scatter_logw_age <- scatter(data = df, x_var = age, y_var = lnw, x_lab = "Age", y_lab = "Log of Hourly wages") 

# D. Bin scatters

# Gender
bin_scatter_felame_w <- bin_scatters_multi(data = df, x_var = female, y_var = w, x_lab = "Gender", y_lab = "Hourly wages") + scale_x_discrete(labels = c("Male", "Female")) 

bin_scatter_felame_logw <- bin_scatters_multi(data = df, x_var = female, y_var = lnw, x_lab = "Gender", y_lab = "Log of Hourly wages") + scale_x_discrete(labels = c("Male", "Female")) 


# Job type
bin_scatter_jobtype_w <- bin_scatters_multi(data = df, x_var = class_cat, y_var = w, x_lab = "Job type", y_lab = "Hourly wages") + scale_x_discrete(labels = c("Government", "Private")) 

bin_scatter_jobtype_logw <- bin_scatters_multi(data = df, x_var = class_cat, y_var = lnw, x_lab = "Job type", y_lab = "Log of Hourly wages") + scale_x_discrete(labels = c("Government", "Private")) 


# Education
bin_scatter_educ_w <- bin_scatters_multi(data = df, x_var = educ, y_var = w, x_lab = "Education level", y_lab = "Hourly wages") + scale_x_discrete(labels = c("BA Degree", "MA Degree", "Professional", "PhD")) 

bin_scatter_educ_logw <- bin_scatters_multi(data = df, x_var = educ, y_var = lnw, x_lab = "Education level", y_lab = "Log of Hourly wages") + scale_x_discrete(labels = c("BA Degree", "MA Degree", "Professional", "PhD")) 


# Union membership
bin_scatter_union_w <- bin_scatters_multi(data = df, x_var = union_membership, y_var = w, x_lab = "Member of union", y_lab = "Hourly wages") + scale_x_discrete(labels = c("No", "Yes")) 

bin_scatter_union_logw <- bin_scatters_multi(data = df, x_var = union_membership, y_var = lnw, x_lab = "Member of union", y_lab = "Log of Hourly wages") + scale_x_discrete(labels = c("No", "Yes")) 


# Child
bin_scatter_child_w <- bin_scatters_multi(data = df, x_var = has_child, y_var = w, x_lab = "Has own child", y_lab = "Hourly wages") + scale_x_discrete(labels = c("No", "Yes")) 

bin_scatter_child_logw <- bin_scatters_multi(data = df, x_var = has_child, y_var = lnw, x_lab = "Has own child", y_lab = "Log of Hourly wages") + scale_x_discrete(labels = c("No", "Yes")) 

# State
bin_scatters_multi(data = df, x_var = state, y_var = lnw, x_lab = "State", y_lab = "Log of Hourly wages") 


# Pairwise summary table
# ggpairs(df %>% select(-c(state, hhid, educ, uhours, earnwke, agesq, agecu, agequ)))

```

```{r eda_interactions, echo = F, include = F}

# EDA

# E. Interactions
# Moved to Appendix A4

# Education and gender
eda_interactions <- interactions(df = df, outcome_var ="w", factor_var = "educ", dummy_var = "female", outcome_lab = "Mean Hourly wage", factor_lab = "Education level", dummy_lab = "Gender") 

# Age and gender
scatter_w_age_male <- scatter(data = df %>% filter(female == 0), x_var = age, y_var = w, x_lab = "Age", y_lab = "Hourly wages") 
scatter_w_age_female <- scatter(data = df %>% filter(female == 1), x_var = age, y_var = w, x_lab = "Age", y_lab = "Hourly wages") 

```

### Predictors of hourly wages


### Regression analysis and model comparison
\vspace{-3mm}


```{r regressions, echo = F, include = F}

# Model estimation 

# Model 1: Simple linear regression
model1 <- as.formula(w ~ age + agesq ) 

# Model 2:
model2 <- as.formula(w ~ age + agesq + female + educ_MA + educ_Profess + educ_PhD ) 

# Model 3:
model3 <- as.formula(w ~ age + agesq + female + educ_MA + educ_Profess + educ_PhD + union_membership + class_cat + has_child)

# Model 4:
model4 <- as.formula(w ~ age + agesq + female + educ_MA + educ_Profess + educ_PhD + female * age + female * agesq + female * educ_MA + union_membership + class_cat + has_child)


# A. Running models
reg1 <- feols(model1, data=df, vcov = 'hetero')
reg2 <- feols(model2, data=df, vcov = 'hetero')
reg3 <- feols(model3, data=df, vcov = 'hetero')
reg4 <- feols(model4, data=df, vcov = 'hetero')


# B. Evaluation of the models: a) RMSE in full sample and c) BIC in full sample
 
# Create variable name list
varname_report <- c("(Intercept)" = "Intercept",
                    "w" = "Hourly wage",
                    "age" = "Age",
                    "agesq" = "Age sqare",
                    "female" = "Female",
                    "educ_MA" = "Education - MA",
                    "educ_Profess" = "Education - Professional", 
                    "educ_PhD" = "Education - PhD",
                    "union_membership" = "Union member",
                    "class_cat" = "Private sector",
                    "has_child" = "Has child")

# Register number of coeffs estimated                   
fitstat_register("k", function(x){length( x$coefficients ) - 1}, "No. Variables")

# Save regression output as latex table
etable( reg1 , reg2 , reg3 , reg4 ,
        title = 'Regression models for predicting horly wages',
        #headers = c("(1)","(2)","(3)","(4)"),
        dict = varname_report,
        # drop = vars_omit ,
        # group = groupConf ,
        se.below = TRUE,
        se.row = FALSE,
        # coefstat = 'se',
        fitstat = c('aic','bic','rmse','r2','ar2', 'n','k'),
        tex = TRUE, 
        file = 'reg.tex',
        replace = TRUE)


```


```{r cv, echo = F, include = F}

# Cross-validation

# C. Evaluation of the models: b) Cross-validated RMSE
k <- 4

# Model 1 
set.seed(20220122)
cv1 <- train(model1, df, method = "lm", trControl = trainControl(method = "cv", number = k))
summary(cv1)

# Model 2
set.seed(20220122)
cv2 <- train(model2, df, method = "lm", trControl = trainControl(method = "cv", number = k))

# Model 3
set.seed(20220122)
cv3 <- train(model3, df, method = "lm", trControl = trainControl(method = "cv", number = k))

# Model 4
set.seed(13505)
cv4 <- train(model4, df, method = "lm", trControl = trainControl(method = "cv", number = k))

cv <- c("cv1", "cv2", "cv3", "cv4")
rmse_cv <- c()

for(i in 1:length(cv)){
  rmse_cv[i] <- sqrt((get(cv[i])$resample[[1]][1]^2 +
                       get(cv[i])$resample[[1]][2]^2 +
                       get(cv[i])$resample[[1]][3]^2 +
                       get(cv[i])$resample[[1]][4]^2)/4)
}


# summarize results
cv_mat <- data.frame(rbind(cv1$resample[4], "Average"),
           rbind(cv1$resample[1], rmse_cv[1]),
           rbind(cv2$resample[1], rmse_cv[2]),
           rbind(cv3$resample[1], rmse_cv[3]),
           rbind(cv4$resample[1], rmse_cv[4])
           )

colnames(cv_mat)<-c("Resample","Model1", "Model2", "Model3", "Model4")
cv_mat #CV RMSE: Model3

```


### Performance and model complexity
\vspace{-3mm}


```{r model_complexity, echo = F, fig.align="center", fig.height=2.8, fig.width=4}

m_comp <- c()
models <- c("reg1", "reg2", "reg3", "reg4")

for( i in 1 : length(cv) ){
  m_comp[ i ] <- length( get( models[i] )$coefficient  - 1 ) 
}

m_comp <- tibble( model = models , 
                  complexity = m_comp,
                  RMSE = rmse_cv )

ggplot( m_comp , aes( x = complexity , y = RMSE ) ) +
  geom_point(color='red',size=2) +
  geom_line(color='blue',size=0.5)+
  labs(x='Number of explanatory variables',y='Averaged RMSE on test samples',
       title='Prediction performance and model compexity') +
  theme_bw()

```





### Summary
\vspace{-3mm}











\newpage
### Appendix
### A1. Descriptive statistics

```{r A1_eda_summary_table, echo = F}

# Descriptive statistics
eda_summary_table

```


\newpage
### A2. One variable analysis

```{r A2_eda_1_var_analysis, echo = F, fig.align='center', fig.height=8, fig.width=10}

# Histograms
grid.arrange( grobs = list(
              hist_earnings,
              hist_hours_worked,
              hist_hourly_wage, 
              hist_log_hourly_wage,
              hist_age),
             ncol=2,
             top = "Fig1.: Histograms",
             bottom = "Note: .")

```


\newpage
### A3. Relationship with outcome variable

```{r A3_eda_2_var_analysis1, echo = F, fig.align='center', fig.height=13, fig.width=10}

# Relationship with outcome
grid.arrange( grobs = list(
              scatter_w_age,
              scatter_logw_age,
              bin_scatter_felame_w, 
              bin_scatter_felame_logw,
              bin_scatter_jobtype_w, 
              bin_scatter_jobtype_logw,
              bin_scatter_educ_w, 
              bin_scatter_educ_logw),
             ncol=2,
             top = "Fig2.: Relationship with outcome",
             bottom = "Note: .")

```

\newpage
```{r A3_eda_2_var_analysis2, echo = F, fig.align='center', fig.height=7, fig.width=10}

# Relationship with outcome
grid.arrange( grobs = list(
              bin_scatter_union_w,
              bin_scatter_union_logw,
              bin_scatter_child_w, 
              bin_scatter_child_logw),
             ncol=2,
             top = "Fig2.: Relationship with outcome",
             bottom = "Note: .")

```


\newpage
### A4. Interactions


```{r A4_eda_interactions, echo = F, fig.align='center', fig.height=8, fig.width=10}

# Interactions
grid.arrange( grobs = list(
              eda_interactions,
              blank,
              scatter_w_age_male + ylim(c(0,120)) + labs(title = "Male"), 
              scatter_w_age_female  + ylim(c(0,120)) + labs(title = "Female") ),
             ncol=2,
             top = "Fig3.: Interactions",
             bottom = "Note: .")



```


\newpage
### A5. Regression

\include{reg.tex}






